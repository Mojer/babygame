<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>BABY RUN！可愛田徑賽</title>
  <style>
    :root{ --bg:#f9fbff; --ink:#1d2b3a; --mint:#b8f1e2; --violet:#dcd0ff; --accent:#7c6cff; --shadow:0 8px 24px rgba(0,0,0,.12); }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#eef5ff);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans TC",sans-serif}
    #app{display:grid;place-items:center;min-height:100dvh;padding:16px}
    .card{width:min(960px,100%);background:white;border-radius:24px;box-shadow:var(--shadow);overflow:hidden;border:2px solid #edf1ff}
    header{padding:16px 20px;display:flex;align-items:center;gap:12px;background:linear-gradient(90deg,var(--mint),var(--violet));border-bottom:2px solid #e7ecff}
    header h1{font-size:20px;margin:0;letter-spacing:.5px;display:flex;align-items:center;gap:8px}
    header .tag{margin-left:auto;background:var(--ink);color:white;padding:6px 10px;border-radius:999px;font-size:12px}

    .wrap{display:grid;grid-template-columns:1fr;gap:12px;padding:12px}
    #ui{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    button, .pill{cursor:pointer;border:0;padding:10px 14px;border-radius:14px;background:var(--ink);color:#fff;box-shadow:var(--shadow);font-weight:700}
    button.secondary{background:#fff;color:var(--ink);border:2px solid #dfe7ff}
    button.ghost{background:transparent;color:var(--ink);border:2px dashed #c7cff7}
    .pill{background:var(--accent)}
    .hint{font-size:12px;opacity:.8}
    .grow{flex:1}

    canvas{width:100%;aspect-ratio:16/9;background:linear-gradient(180deg,#c7ecff 0 45%, #eafff2 45%);border-radius:18px;border:2px solid #e7ecff;touch-action:none}

    /* Mobile controls */
    .mobile-ctrls{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin:8px 0}
    .btn{user-select:none;-webkit-user-select:none;touch-action:manipulation;text-align:center;padding:16px 12px;border-radius:18px;font-weight:800;font-size:18px;background:linear-gradient(180deg,#ffffff,#f2f5ff);border:2px solid #dfe7ff;box-shadow:var(--shadow)}
    .btn:active{transform:translateY(1px)}

    .overlay{position:absolute;inset:0;display:grid;place-items:center}
    .panel{background:white;border:2px solid #e7ecff;border-radius:20px;box-shadow:var(--shadow);padding:18px;max-width:560px;margin:12px}
    .title{font-size:28px;margin:0 0 8px}
    .center{display:grid;place-items:center;gap:10px}

    .bar{height:12px;background:#eef2ff;border:2px solid #dfe7ff;border-radius:999px;overflow:hidden}
    .bar > span{display:block;height:100%;background:linear-gradient(90deg,var(--accent),#88e0ff);width:0%}

    .kkey{display:inline-flex;align-items:center;justify-content:center;border:2px solid #cfd8ff;border-bottom-width:4px;background:white;border-radius:10px;padding:2px 8px;margin:0 2px;font-weight:800}

    footer{padding:8px 16px 16px;font-size:12px;opacity:.8}

    /* 橫向提示（在手機直向時顯示） */
    .rotate-hint{position:fixed;inset:0;display:none;place-items:center;background:rgba(255,255,255,.92);backdrop-filter:saturate(120%) blur(4px);z-index:50}
    .rotate-hint .panel{max-width:360px}
    @media (orientation:portrait) and (max-width:900px){ .rotate-hint{display:grid} }
  </style>
</head>
<body>
<div class="rotate-hint"><div class="panel center"><h3 class="title">📱 建議橫向遊玩</h3><button id="btnIgnoreRotate" class="secondary" style="margin-top:8px">我知道了，繼續</button></div></div>
<div id="app">
  <div class="card">
    <header>
      <h1>🏃‍♀️ BABY RUN！可愛田徑賽</h1>
       
    </header>

    <div class="wrap">
      <div id="gameWrap" style="position:relative">
        <canvas id="game" width="1280" height="720"></canvas>
        <div id="startOverlay" class="overlay">
          <div class="panel center">
            <h2 class="title">準備，預備——<span style="color:var(--accent)">衝！</span></h2>
            <div style="text-align:center">
              連按 <span class="kkey">←</span><span class="kkey">→</span> 加速，<span class="kkey">↑</span> 跳過障礙！<br/>
              手機可用下方大按鈕。
            </div>
            <div class="bar" style="width:100%"><span id="countBar"></span></div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center">
              <button id="btnStart" type="button">開始比賽</button>
              <button id="btnHow" class="secondary" type="button">玩法說明</button>
              <button id="btnFull" class="ghost" type="button">全螢幕</button>
              <button id="btnInstall" class="ghost" type="button" style="display:none">安裝到主畫面</button>
            </div>
          </div>
        </div>
        <div id="finishOverlay" class="overlay" style="display:none">
          <div class="panel center">
            <h2 class="title" id="finishTitle">完成！</h2>
            <div id="finishStats"></div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button id="btnRestart" type="button">再跑一場</button>
              <button id="btnShare" class="secondary" type="button">截圖分享</button>
            </div>
          </div>
        </div>
      </div>

      <div id="ui">
        <div class="pill" id="status">距離：0m｜時間：0.0s｜名次：—</div>
        <div class="grow"></div>
        <button id="btnPause" class="ghost" type="button">暫停</button>
        <button id="btnMute" class="ghost" type="button">🔊</button>
      </div>

      <div class="mobile-ctrls" id="mobileCtrls">
        <div class="btn" data-act="left">左</div>
        <div class="btn" data-act="jump">跳</div>
        <div class="btn" data-act="right">右</div>
      </div>

      <div class="hint">行動優化：大按鈕、橫向提醒、全螢幕、音訊解鎖、可安裝成 App（需 HTTPS）。</div>
    </div>

    <footer>Made with ❤️ for fun · 無需外部素材 · © 2025</footer>
  </div>
</div>

<script>
(()=>{
  const CONFIG = { trackLength:400, lanes:4, obstaclesPer100m:1.2, aiBaseSpeed:4.2, aiRubberBand:0.0035, playerBaseSpeed:3.8, playerBoost:1.25, playerPenalty:-1.1, speedFriction:0.96, jumpVel:10.5, gravity:0.65, laneHeight:110, worldScale:2.0, bgParallax:0.2 };

  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  const TRACK_TOP = H*0.45;

  const uiStatus = document.getElementById('status');
  const btnPause = document.getElementById('btnPause');
  const btnMute = document.getElementById('btnMute');
  const btnStart = document.getElementById('btnStart');
  const btnHow = document.getElementById('btnHow');
  const startOv = document.getElementById('startOverlay');
  const finishOv = document.getElementById('finishOverlay');
  const finishTitle = document.getElementById('finishTitle');
  const finishStats = document.getElementById('finishStats');
  const btnRestart = document.getElementById('btnRestart');
  const btnShare = document.getElementById('btnShare');
  const countBar = document.getElementById('countBar');
  const mobileCtrls = document.getElementById('mobileCtrls');
  const btnFull = document.getElementById('btnFull');
  const btnInstall = document.getElementById('btnInstall');
  const rotateHint = document.querySelector('.rotate-hint');
  const btnIgnoreRotate = document.getElementById('btnIgnoreRotate');

  let gameState = 'ready';
  let elapsed = 0, distance = 0, ranking = '-';
  let muted = false; let deferredPrompt = null;

  // ====== 安全的音訊初始化 ======
  let actx = null;
  try{
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    if (AudioCtx) actx = new AudioCtx();
  }catch(e){ actx = null; }
  function resumeAudio(){ if(actx && actx.state === 'suspended') actx.resume(); window.removeEventListener('pointerdown', resumeAudio); }
  window.addEventListener('pointerdown', resumeAudio, {passive:true});
  function beep(freq=880, dur=0.08, vol=0.04){
    if(muted || !actx) return;
    try{
      const t = actx.currentTime;
      const o = actx.createOscillator();
      const g = actx.createGain();
      o.frequency.value = freq; o.type='sine';
      g.gain.setValueAtTime(vol,t); g.gain.exponentialRampToValueAtTime(0.0001,t+dur);
      o.connect(g).connect(actx.destination); o.start(); o.stop(t+dur);
    }catch(_){ /* 忽略音訊錯誤 */ }
  }
  function haptic(ms=20){ if(navigator.vibrate) try{ navigator.vibrate(ms); }catch(_){} }

  // ====== 世界資料 ======
  const colors = ['#ffb7c5','#b3e5fc','#c8e6c9','#fff59d','#d1c4e9','#ffcdd2'];
  const mascots = ['🐻','🐰','🐱','🐼','🦊','🐵','🐨','🐯'];
  const laneBase = (i)=> TRACK_TOP + (i+1)*CONFIG.laneHeight - 12;

  function createRunner(i, isPlayer=false){
    return { id:i, name:(isPlayer?'你':mascots[i%mascots.length]), x:40, y:laneBase(i), vy:0, onGround:true,
      speed:isPlayer?CONFIG.playerBaseSpeed:CONFIG.aiBaseSpeed*(0.9+Math.random()*0.2), boost:0, dirLast:null,
      dist:0, finished:false, finishTime:null, color:colors[i%colors.length], isPlayer };
  }
  const runners = Array.from({length:CONFIG.lanes}, (_,i)=>createRunner(i, i===0));

  // ====== 障礙 ======
  const obstacles = [];
  function spawnObstacles(){
    const count = Math.max(1, Math.floor(CONFIG.trackLength/100 * CONFIG.obstaclesPer100m));
    obstacles.length = 0;
    for(let i=0;i<count;i++){
      const at = 60 + Math.random()*(CONFIG.trackLength-100);
      const lane = Math.floor(Math.random()*CONFIG.lanes);
      obstacles.push({m:at, lane, w:22, h:24, hit:false});
    }
    obstacles.sort((a,b)=>a.m-b.m);
  }
  spawnObstacles();

  // ====== 輸入 ======
  function altBoost(side){ const p=runners[0]; if(p.finished) return; if(p.dirLast && p.dirLast===side){ p.boost += CONFIG.playerPenalty; beep(220,0.05,0.03); } else { p.boost += CONFIG.playerBoost; beep(880,0.05,0.04); } p.dirLast=side; haptic(); }
  function tryJump(r){ if(r.onGround){ r.vy = -CONFIG.jumpVel; r.onGround=false; beep(660,0.07,0.045); haptic(30);} }

  window.addEventListener('keydown', (e)=>{
    if(['ArrowLeft','ArrowRight','ArrowUp',' '].includes(e.key)) e.preventDefault();
    if(e.key==='ArrowLeft')  altBoost('L');
    if(e.key==='ArrowRight') altBoost('R');
    if(e.key==='ArrowUp' || e.key===' ') tryJump(runners[0]);
  });

  mobileCtrls.addEventListener('touchstart', (e)=>{
    const t = e.target.closest('.btn'); if(!t) return;
    const act = t.dataset.act;
    if(act==='left') altBoost('L');
    if(act==='right') altBoost('R');
    if(act==='jump') tryJump(runners[0]);
  }, {passive:true});

  // ====== 狀態切換 ======
  function reset(){
    elapsed=0; distance=0; ranking='-'; spawnObstacles();
    for(let i=0;i<runners.length;i++){
      const r = runners[i]; r.x=40; r.vy=0; r.onGround=true; r.boost=0; r.dist=0; r.finished=false; r.finishTime=null; r.dirLast=null; r.y=laneBase(i);
      r.speed = r.isPlayer? CONFIG.playerBaseSpeed : CONFIG.aiBaseSpeed*(0.9+Math.random()*0.2);
    }
    gameState='ready'; startOv.style.display='grid'; finishOv.style.display='none';
  }
  function start(){
    rotateHint.style.display='none';
    if(gameState==='running') return;
    gameState='running'; elapsed=0; startOv.style.display='none'; last=performance.now(); animate();
  }
  function finish(){
    gameState='finished';
    const order=[...runners].sort((a,b)=> (a.finishTime??1e9)-(b.finishTime??1e9));
    const rank = order.findIndex(r=>r.isPlayer)+1;
    finishTitle.textContent = rank===1? '🥇 你是第一名！' : `完成！第 ${rank} 名`;
    const my = runners[0];
    finishStats.innerHTML = `用時 <b>${my.finishTime.toFixed(2)}s</b>｜總距離 <b>${CONFIG.trackLength}m</b><br/>對手成績：`+
      order.map((r,i)=> `${i+1}. ${r.isPlayer? '你' : r.name} — ${r.finishTime.toFixed(2)}s`).join('<br/>');
    finishOv.style.display='grid'; beep(520,0.12,0.06); setTimeout(()=>beep(660,0.12,0.06),120); setTimeout(()=>beep(800,0.12,0.06),240);
  }

  // 按鈕事件
  btnStart?.addEventListener('click', start);
  btnHow?.addEventListener('click', ()=>{
    alert(`玩法：交替按鍵盤 ← → 讓主角加速，↑ 或空白鍵跳過障礙。\n手機可點下方按鈕操作。先到達 400m 終點者勝！`);
  });
  btnRestart?.addEventListener('click', ()=>{ reset(); start(); });
  btnShare?.addEventListener('click', ()=>{ const url=canvas.toDataURL('image/png'); const a=document.createElement('a'); a.href=url; a.download='cute-run.png'; a.click(); });
  btnPause?.addEventListener('click', ()=>{ if(gameState!=='running'){ start(); btnPause.textContent='暫停'; return; } gameState='paused'; btnPause.textContent='繼續'; });
  btnMute?.addEventListener('click', ()=>{ muted=!muted; btnMute.textContent = muted? '🔇' : '🔊'; });
  btnFull?.addEventListener('click', async()=>{ try{ const el=document.documentElement; if(!document.fullscreenElement){ await el.requestFullscreen?.(); } else { await document.exitFullscreen?.(); } }catch(err){ console.warn('fullscreen failed', err); } });
  btnIgnoreRotate?.addEventListener('click', ()=>{ rotateHint.style.display='none'; });
  window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt=e; btnInstall.style.display='inline-block'; });
  btnInstall?.addEventListener('click', async()=>{ if(!deferredPrompt) return alert('請以 HTTPS 部署此檔案，再試一次。'); deferredPrompt.prompt(); const choice=await deferredPrompt.userChoice; deferredPrompt=null; if(choice.outcome!=='accepted'){ alert('已取消安裝，可稍後再試。'); } });

  // 點擊面板空白處也能啟動
  startOv.addEventListener('pointerdown', (e)=>{ if(gameState==='ready' && e.target===startOv) start(); });

  // ====== 遊戲邏輯 ======
  function update(dt){ if(gameState!=='running') return;
    elapsed += dt;
    const p = runners[0]; p.speed = (p.speed + p.boost) * CONFIG.speedFriction; p.boost *= 0.85; p.speed = Math.max(1.2, Math.min(p.speed, 14));
    const lead = Math.max(...runners.map(r=>r.dist));
    for(let i=1;i<runners.length;i++){
      const r = runners[i]; if(r.finished) continue; const luck=(Math.random()-0.5)*0.12; const gap=(lead - r.dist); r.speed += CONFIG.aiRubberBand*gap + luck; r.speed = Math.max(2.4, Math.min(r.speed, 12));
    }
    for(const r of runners){ if(r.finished) continue; r.dist += r.speed * 0.08 * CONFIG.worldScale; if(r.dist>=CONFIG.trackLength){ r.dist=CONFIG.trackLength; r.finished=true; r.finishTime=elapsed; }
      r.y += r.vy; r.vy += CONFIG.gravity; if(r.y>=laneBase(r.id)){ r.y=laneBase(r.id); r.vy=0; r.onGround=true; } }
    for(const obs of obstacles){ for(const r of runners){ if(r.finished||r.id!==obs.lane||obs.hit) continue; const m=obs.m; const near=Math.abs(r.dist-m)<2.2; const low=r.onGround&&r.vy===0; if(near&&low){ r.speed*=0.4; r.dist=Math.max(0, r.dist-1.5); obs.hit=true; if(r.isPlayer) beep(180,0.08,0.05); } } }
    if(runners.every(r=>r.finished)) finish();
    const orderNow=[...runners].sort((a,b)=> b.dist-a.dist); const rankNow=orderNow.findIndex(r=>r.isPlayer)+1; ranking=rankNow; distance=runners[0].dist; uiStatus.textContent = `距離：${distance.toFixed(1)}m｜時間：${elapsed.toFixed(1)}s｜名次：${ranking}/${CONFIG.lanes}`;
  }

  // ====== 繪製 ======
  function drawBackground(camX){ const skyH=H*0.45; ctx.fillStyle='#b9e3ff'; ctx.fillRect(0,0,W,skyH); const baseY=skyH-40; ctx.fillStyle='#a6d2f9'; for(let i=0;i<12;i++){ const x=((i*240 - camX*CONFIG.bgParallax*0.4)% (W+300)) - 150; ctx.beginPath(); ctx.moveTo(x, baseY); ctx.quadraticCurveTo(x+60, baseY-90, x+160, baseY); ctx.fill(); } ctx.fillStyle='#dff6e5'; ctx.fillRect(0, skyH, W, H-skyH); ctx.fillStyle='rgba(130,220,170,.6)'; ctx.fillRect(0, skyH, W, 30); }
  function drawTrack(camX){ const top=TRACK_TOP; const trackH=CONFIG.lanes*CONFIG.laneHeight; ctx.fillStyle='#f7d9ba'; ctx.fillRect(0, top, W, trackH); for(let i=0;i<=CONFIG.lanes;i++){ const y=top + i*CONFIG.laneHeight; ctx.strokeStyle='white'; ctx.lineWidth=4; ctx.setLineDash([16,12]); ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(W, y); ctx.stroke(); } ctx.setLineDash([]); ctx.fillStyle='#ffffffaa'; ctx.font='bold 16px system-ui'; ctx.textAlign='center'; ctx.textBaseline='top'; for(let m=0;m<=CONFIG.trackLength;m+=50){ const x=worldToScreen(m, camX); ctx.fillRect(x-1, top, 2, trackH); ctx.fillText(m+'m', x, top+6); } const fx=worldToScreen(CONFIG.trackLength, camX); ctx.fillStyle='#fff'; for(let i=0;i<12;i++) ctx.fillRect(fx-2, top+i*10, 4, 6); }
  function worldToScreen(m, camX){ const pxPerM=5.4*CONFIG.worldScale; return W*0.2 + (m - runners[0].dist)*pxPerM - camX; }
  function drawRunner(r, camX){ const x=worldToScreen(r.dist, camX), y=r.y; ctx.fillStyle=r.color; const w=56,h=36,rad=18; roundRect(ctx, x-w/2, y-h, w, h, rad); ctx.fill(); ctx.fillStyle='white'; roundRect(ctx, x-w/2+8, y-h+6, w-16, h-16, 14); ctx.fill(); ctx.fillStyle='#2b2b2b'; const blink=(Math.sin(performance.now()/180 + r.id) > 0.95); const ey=y-h+16; ctx.beginPath(); ctx.arc(x-10, ey, blink?1:3, 0, Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(x+10, ey, blink?1:3, 0, Math.PI*2); ctx.fill(); ctx.fillStyle='#ffffff'; ctx.fillRect(x-14, y-h+20, 28, 12); ctx.fillStyle='#333'; ctx.font='bold 10px system-ui'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(r.name, x, y-h+26); ctx.strokeStyle='#444'; ctx.lineWidth=3; ctx.lineCap='round'; const phase=performance.now()/100 + r.id*0.8 + r.speed*0.3; const k=Math.sin(phase)*8; ctx.beginPath(); ctx.moveTo(x-8, y-2); ctx.lineTo(x-8, y+8+k); ctx.stroke(); ctx.beginPath(); ctx.moveTo(x+8, y-2); ctx.lineTo(x+8, y+8-k); ctx.stroke(); if(!r.isPlayer){ ctx.font='20px system-ui'; ctx.textAlign='center'; ctx.textBaseline='bottom'; ctx.fillText(r.name, x, y-h-8); } if(r.finished && r.isPlayer){ ctx.font='bold 28px system-ui'; ctx.fillStyle='#7c6cff'; ctx.textAlign='left'; ctx.textBaseline='top'; ctx.fillText('衝線！', 16, 16); } }
  function drawObstacles(camX){ for(const o of obstacles){ const x=worldToScreen(o.m, camX), y=laneBase(o.lane)-4; ctx.fillStyle=o.hit?'#cfd8dc':'#ff8a80'; roundRect(ctx, x-12, y-26, 24, 24, 6); ctx.fill(); ctx.fillStyle='white'; ctx.fillRect(x-10, y-22, 20, 6); } }
  function roundRect(ctx,x,y,w,h,r){ const rr=Math.min(r, w/2, h/2); ctx.beginPath(); ctx.moveTo(x+rr, y); ctx.arcTo(x+w, y, x+w, y+h, rr); ctx.arcTo(x+w, y+h, x, y+h, rr); ctx.arcTo(x, y+h, x, y, rr); ctx.arcTo(x, y, x+w, y, rr); ctx.closePath(); }

  function render(){ const camX=0; ctx.clearRect(0,0,W,H); drawBackground(camX + runners[0].dist*6); drawTrack(camX); drawObstacles(camX); const order=[...runners].sort((a,b)=> a.y-b.y); for(const r of order) drawRunner(r, camX); }

  let last = performance.now();
  function animate(){ const now=performance.now(); const dt=Math.min(0.05, (now-last)/1000); last=now; if(gameState==='running') update(dt); render(); if(gameState!=='finished') requestAnimationFrame(animate); }
  function idleBar(){ if(gameState!=='ready') return; const t=(Math.sin(performance.now()/600)+1)/2; countBar.style.width=(8+t*84)+'%'; requestAnimationFrame(idleBar); }
  idleBar(); reset();

  // Service Worker（可選）：需 HTTPS + sw.js
  if('serviceWorker' in navigator && location.protocol.startsWith('http')){
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  }
})();
</script>
</body>
</html>
